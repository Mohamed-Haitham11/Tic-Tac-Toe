name: TicTacToe Qt CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest # Sticking to ubuntu-latest for simplicity and apt-get

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Qt dependencies via apt-get # Reverting to apt-get for stability
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential qtbase5-dev libqt5sql5-sqlite

    - name: Generate Makefile using qmake
      # qmake reads your project file (.pro) and generates a Makefile
      # Ensure 'Final.pro' is in the root of your repository, or adjust the path.
      run: qmake Final.pro

    - name: Build project
      # make compiles the source files, links libraries, and creates the executable.
      run: make -j$(nproc)

    - name: Run simple test (optional)
      # Assumes your executable name is 'tictactoe' based on the TARGET in your .pro file.
      run: ./tictactoe || true

    - name: Upload built binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: tictactoe-qt-build-ubuntu-latest
        path: tictactoe # Ensure this matches your actual executable name

  release:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest

    permissions:
      contents: write # This permission is required to create a GitHub Release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download built binary artifact (Ubuntu)
      uses: actions/download-artifact@v4
      with:
        name: tictactoe-qt-build-ubuntu-latest
        path: .

    - name: Get current date for release tag
      id: date
      run: echo "RELEASE_DATE=$(date +'%Y.%m.%d-%H%M')" >> "$GITHUB_OUTPUT"

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.RELEASE_DATE }}-${{ github.sha }}
        name: Release ${{ steps.date.outputs.RELEASE_DATE }} (Ubuntu)
        body: |
          Automated release of the TicTacToe Qt application for Ubuntu.
          This release contains the binary built from commit `${{ github.sha }}`.

          **Important Note for Distribution:**
          This artifact is the executable file. For your Qt application to run on
          other machines (especially those without Qt installed), you will typically
          need to bundle it with the necessary Qt shared libraries. On Linux, tools like
          `linuxdeployqt` can help with this. For Windows, `windeployqt.exe` is used.
          This workflow currently only uploads the executable itself.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Asset (Ubuntu)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tictactoe
        asset_name: tictactoe-ubuntu-latest
        asset_content_type: application/octet-stream
